{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 247, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/lib/data.ts"],"sourcesContent":["/**\n * @fileOverview Datos de prueba para la aplicación.\n * Este archivo contiene datos de ejemplo para campañas y contactos,\n * utilizados para poblar la interfaz de usuario hasta que se conecte una base de datos real.\n */\n\n/**\n * Datos de ejemplo para las campañas de correo electrónico.\n */\nexport const campaigns = [\n  {\n    name: \"Campaña de Bienvenida\",\n    status: \"TERMINADA\",\n    sent: \"5,000\",\n    opens: \"35%\",\n    clicks: \"8%\",\n    date: \"2024-07-01\",\n  },\n  {\n    name: \"Oferta Flash 24h\",\n    status: \"EXPIRADA\",\n    sent: \"2,500\",\n    opens: \"45%\",\n    clicks: \"15%\",\n    date: \"2024-07-10\",\n  },\n  {\n    name: \"Lanzamiento Nuevo Producto\",\n    status: \"INICIADA\",\n    sent: \"1,200\",\n    opens: \"12%\",\n    clicks: \"2%\",\n    date: \"2024-07-18\",\n  },\n  {\n    name: \"Promoción Black Friday\",\n    status: \"TIEMPO LIMITADO\",\n    sent: \"0\",\n    opens: \"-\",\n    clicks: \"-\",\n    date: \"2024-11-29\",\n  },\n  {\n    name: \"Venta de Aniversario\",\n    status: \"AGOTADA\",\n    sent: \"10,000\",\n    opens: \"50%\",\n    clicks: \"20%\",\n    date: \"2024-06-15\",\n  },\n];\n\n/**\n * Datos de ejemplo para las plantillas de correo.\n */\nexport const templates = [\n  {\n    id: \"1\",\n    name: \"Newsletter Mensual\",\n    description: \"Plantilla estándar para el boletín informativo de cada mes.\",\n    image: \"https://placehold.co/600x400.png\",\n    aiHint: \"abstract pattern\"\n  },\n  {\n    id: \"2\",\n    name: \"Anuncio de Producto\",\n    description: \"Plantilla para anunciar nuevos productos o características.\",\n    image: \"https://placehold.co/600x400.png\",\n    aiHint: \"product launch\"\n  },\n  {\n    id: \"3\",\n    name: \"Oferta Especial\",\n    description: \"Diseño llamativo para promociones y descuentos.\",\n    image: \"https://placehold.co/600x400.png\",\n    aiHint: \"special offer\"\n  },\n];\n\n\n/**\n * Datos de ejemplo para los contactos.\n */\nexport const contacts = [\n  {\n    email: \"juan.perez@example.com\",\n    name: \"Juan Perez\",\n    status: \"Suscrito\",\n    dateAdded: \"2024-07-10\",\n  },\n  {\n    email: \"maria.garcia@example.com\",\n    name: \"Maria Garcia\",\n    status: \"Suscrito\",\n    dateAdded: \"2024-07-09\",\n  },\n  {\n    email: \"baja@example.com\",\n    name: \"Carlos Baja\",\n    status: \"Baja\",\n    dateAdded: \"2024-06-20\",\n  },\n];\n\n/**\n * Datos de ejemplo para las encuestas.\n */\nexport const surveys = [\n  {\n    id: \"1\",\n    name: \"Feedback de Producto de TI\",\n    description: \"Encuesta para recopilar opiniones sobre nuestro último software.\",\n    responses: 150,\n  },\n  {\n    id: \"2\",\n    name: \"Satisfacción del Cliente Tech\",\n    description: \"Mide la satisfacción general de nuestros clientes con el soporte técnico.\",\n    responses: 278,\n  },\n  {\n    id: \"3\",\n    name: \"Interés en Nuevos Cursos\",\n    description: \"Sondeo sobre posibles nuevos cursos de desarrollo y TI.\",\n    responses: 45,\n  },\n];\n\n/**\n * Datos de ejemplo para los eventos.\n */\nexport const events = [\n  {\n    id: \"1\",\n    name: \"Taller de Marketing Digital\",\n    date: \"2024-08-15\",\n    status: \"Realizado\",\n    attendees: 75,\n  },\n  {\n    id: \"2\",\n    name: \"Conferencia de Liderazgo\",\n    date: \"2024-09-05\",\n    status: \"Próximo\",\n    attendees: 120,\n  },\n  {\n    id: \"3\",\n    name: \"Webinar de Nuevas Tecnologías\",\n    date: \"2024-07-20\",\n    status: \"Realizado\",\n    attendees: 250,\n  },\n];\n\n/**\n * Plantillas de certificados de ejemplo (mapeado por event.id).\n * El contenido es una imagen PNG codificada en base64.\n */\nexport const certificateTemplates = {\n  '1': 'iVBORw0KGgoAAAANSUhEUgAAAMgAAABkCAYAAADDlWIpAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAGSSURBVHhe7dJBDQAgDAAx2NB/yHwM46GE+zs7+8HBAgQIECAwERAgQIAAgYmAAAECEAEDAgECEQEBAgECEQEBAgECBAgQCAmY+wEECBAgQCAhIM4DBAgQIEAgISDOAwQIECBAICEgzoMECBAgQCAhIM4DBAgQIEAgISDOAwQIECBAICEgzoMECBAgQCAhIM4DBAgQIEAgISDOAwQIECBAICEgzoMECBAgQCAhIM4DBAgQIEAgISDOAwQIECBAICEgzoMECBAgQCAhIM4DBAgQIEAgISDOAwQIECBAICEgzoMECBAgQCAhIM4DBAgQIEAgISDOAwQIECBAICEgzoMECBAgQCAhIM4DBAgQIEAgISDOAwQIECBAICEgzoMECBAgQCAhIM4DBAgQIEAgISDOAwQIECBAICEgzoMECBAgQCAhIM4DBAgQIEAgISDOAwQIECBAICEgzoMECBAgQCAhIM4DBAgQIEAgISDOAwQIECBAICEgzoMECBAgQCAhIM4DBAgQIEAgISDOAwQIECBAICEgzoMECBAgQCAhIM4DBAgQIEAgISDOAwQIECBAICEgzoMECBAgQCAhIM4DBAgQIECAQEBAgAABAq8CgU5q3+UAAAAASUVORK5CYII=',\n};\n"],"names":[],"mappings":"AAAA;;;;CAIC,GAED;;CAEC;;;;;;;;AACM,MAAM,YAAY;IACvB;QACE,MAAM;QACN,QAAQ;QACR,MAAM;QACN,OAAO;QACP,QAAQ;QACR,MAAM;IACR;IACA;QACE,MAAM;QACN,QAAQ;QACR,MAAM;QACN,OAAO;QACP,QAAQ;QACR,MAAM;IACR;IACA;QACE,MAAM;QACN,QAAQ;QACR,MAAM;QACN,OAAO;QACP,QAAQ;QACR,MAAM;IACR;IACA;QACE,MAAM;QACN,QAAQ;QACR,MAAM;QACN,OAAO;QACP,QAAQ;QACR,MAAM;IACR;IACA;QACE,MAAM;QACN,QAAQ;QACR,MAAM;QACN,OAAO;QACP,QAAQ;QACR,MAAM;IACR;CACD;AAKM,MAAM,YAAY;IACvB;QACE,IAAI;QACJ,MAAM;QACN,aAAa;QACb,OAAO;QACP,QAAQ;IACV;IACA;QACE,IAAI;QACJ,MAAM;QACN,aAAa;QACb,OAAO;QACP,QAAQ;IACV;IACA;QACE,IAAI;QACJ,MAAM;QACN,aAAa;QACb,OAAO;QACP,QAAQ;IACV;CACD;AAMM,MAAM,WAAW;IACtB;QACE,OAAO;QACP,MAAM;QACN,QAAQ;QACR,WAAW;IACb;IACA;QACE,OAAO;QACP,MAAM;QACN,QAAQ;QACR,WAAW;IACb;IACA;QACE,OAAO;QACP,MAAM;QACN,QAAQ;QACR,WAAW;IACb;CACD;AAKM,MAAM,UAAU;IACrB;QACE,IAAI;QACJ,MAAM;QACN,aAAa;QACb,WAAW;IACb;IACA;QACE,IAAI;QACJ,MAAM;QACN,aAAa;QACb,WAAW;IACb;IACA;QACE,IAAI;QACJ,MAAM;QACN,aAAa;QACb,WAAW;IACb;CACD;AAKM,MAAM,SAAS;IACpB;QACE,IAAI;QACJ,MAAM;QACN,MAAM;QACN,QAAQ;QACR,WAAW;IACb;IACA;QACE,IAAI;QACJ,MAAM;QACN,MAAM;QACN,QAAQ;QACR,WAAW;IACb;IACA;QACE,IAAI;QACJ,MAAM;QACN,MAAM;QACN,QAAQ;QACR,WAAW;IACb;CACD;AAMM,MAAM,uBAAuB;IAClC,KAAK;AACP","debugId":null}},
    {"offset": {"line": 398, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/app/actions/send-campaign-action.ts"],"sourcesContent":["\n'use server';\n\nimport 'isomorphic-fetch';\nimport { ClientSecretCredential } from '@azure/identity';\nimport { Client } from '@microsoft/microsoft-graph-client';\nimport { TokenCredentialAuthenticationProvider } from '@microsoft/microsoft-graph-client/authProviders/azureTokenCredentials';\nimport mysql from 'mysql2/promise';\nimport { parse } from 'csv-parse/sync';\nimport * as XLSX from 'xlsx';\nimport { events } from '@/lib/data';\n\n/**\n * @fileoverview Acción de servidor para enviar una campaña de correo electrónico.\n * Obtiene destinatarios desde una fuente de datos y los envía por lotes\n * para respetar los límites de la API, utilizando Microsoft Graph.\n */\n\ninterface SendCampaignPayload {\n  subject: string;\n  htmlBody: string;\n  recipientData: {\n    type: 'date' | 'csv' | 'sql' | 'excel';\n    value: string;\n  };\n  batchSize: number;\n  emailDelay: number; // ms\n  batchDelay: number; // s\n  attachment?: {\n    filename: string;\n    contentType: string;\n    content: string; // base64 content\n  };\n  eventId?: string;\n}\n\ninterface Recipient {\n  email: string;\n  name?: string;\n}\n\n/**\n * Obtiene una lista de destinatarios desde la fuente especificada.\n */\nasync function getRecipients(\n  recipientData: SendCampaignPayload['recipientData']\n): Promise<Recipient[]> {\n  const { type, value } = recipientData;\n\n  const findKey = (obj: object, potentialKeys: string[]) => {\n    const key = Object.keys(obj).find(k => potentialKeys.includes(k.toLowerCase()));\n    return key ? obj[key as keyof typeof obj] : undefined;\n  };\n\n  if (type === 'csv') {\n    try {\n      const records = parse(value, {\n        columns: true,\n        skip_empty_lines: true,\n      });\n      if (records.length === 0) return [];\n      \n      const emailKey = Object.keys(records[0]).find(k => k.toLowerCase() === 'email');\n      if (!emailKey) throw new Error('La columna \"email\" no se encontró en el archivo CSV.');\n      \n      return records.map((record: any) => ({\n        email: record[emailKey],\n        name: findKey(record, ['name', 'nombre', 'fullname', 'nombre completo']),\n      })).filter((r: Recipient) => r.email && r.email.includes('@'));\n    } catch (error) {\n      console.error('Error al procesar el archivo CSV:', error);\n      throw new Error(`Error al procesar el archivo CSV: ${(error as Error).message}`);\n    }\n  }\n\n  if (type === 'excel') {\n    try {\n      const buffer = Buffer.from(value, 'base64');\n      const workbook = XLSX.read(buffer, { type: 'buffer' });\n      const sheetName = workbook.SheetNames[0];\n      const worksheet = workbook.Sheets[sheetName];\n      const jsonData: any[] = XLSX.utils.sheet_to_json(worksheet);\n      if (jsonData.length === 0) return [];\n\n      const emailKey = Object.keys(jsonData[0]).find(key => key.toLowerCase() === 'email');\n      if (!emailKey) throw new Error('La columna \"email\" no se encontró en el archivo Excel.');\n\n      return jsonData.map(row => ({\n        email: row[emailKey],\n        name: findKey(row, ['name', 'nombre', 'fullname', 'nombre completo']),\n      })).filter(r => r.email && typeof r.email === 'string' && r.email.includes('@'));\n    } catch (error) {\n      console.error('Error al procesar el archivo Excel:', error);\n      throw new Error(`Error al procesar el archivo Excel: ${(error as Error).message}`);\n    }\n  }\n\n  const { MYSQL_HOST, MYSQL_USER, MYSQL_PASSWORD, MYSQL_DATABASE, MYSQL_PORT } = process.env;\n  if (!MYSQL_HOST || !MYSQL_USER || !MYSQL_DATABASE) {\n    throw new Error('Faltan las variables de entorno de la base de datos. Por favor, configúralas.');\n  }\n\n  let connection;\n  try {\n    connection = await mysql.createConnection({\n      host: MYSQL_HOST,\n      port: MYSQL_PORT ? parseInt(MYSQL_PORT, 10) : 3306,\n      user: MYSQL_USER,\n      password: MYSQL_PASSWORD,\n      database: MYSQL_DATABASE,\n    });\n\n    let sql_query = '';\n    let params: any[] = [];\n\n    if (type === 'date') {\n      sql_query = `\n        SELECT t1.email, t1.nombre_completo as name\n        FROM order_data AS t1 INNER JOIN order_data_online AS t2 ON t1.Ds_Merchant_Order = t2.Ds_Order\n        WHERE\n            t1.fecha_visita = ?\n            AND t2.Ds_ErrorCode = '00'\n            AND t2.Ds_ErrorMessage = 'completed'\n            AND NOT t1.email IN ('alberto.silva@papalote.org.mx', 'alejandracervantesm@gmail.com')\n      `;\n      params = [value];\n    } else if (type === 'sql') {\n      sql_query = value;\n    }\n\n    const [rows] = await connection.execute(sql_query, params);\n    return (rows as Recipient[]).filter(row => row.email);\n  } catch (error) {\n    console.error('Error al conectar o consultar la base de datos:', error);\n    throw new Error('No se pudo obtener los contactos de la base de datos.');\n  } finally {\n    if (connection) await connection.end();\n  }\n}\n\nasync function getGraphClient() {\n    const { GRAPH_CLIENT_ID, GRAPH_TENANT_ID, GRAPH_CLIENT_SECRET } = process.env;\n    if (!GRAPH_CLIENT_ID || !GRAPH_TENANT_ID || !GRAPH_CLIENT_SECRET) {\n        throw new Error('Faltan las variables de entorno de Microsoft Graph. Por favor, configúralas.');\n    }\n    const credential = new ClientSecretCredential(GRAPH_TENANT_ID, GRAPH_CLIENT_ID, GRAPH_CLIENT_SECRET);\n    const authProvider = new TokenCredentialAuthenticationProvider(credential, { scopes: ['https://graph.microsoft.com/.default'] });\n    return Client.initWithMiddleware({ authProvider });\n}\n\nconst delay = (ms: number) => new Promise(res => setTimeout(res, ms));\n\nexport async function sendCampaign(payload: SendCampaignPayload) {\n  const { subject, htmlBody, recipientData, batchSize, emailDelay, batchDelay, attachment, eventId } = payload;\n  const startTime = Date.now();\n\n  const { GRAPH_USER_MAIL } = process.env;\n  if (!GRAPH_USER_MAIL) {\n    throw new Error('Falta la variable de entorno GRAPH_USER_MAIL. Por favor, configúrala.');\n  }\n\n  const recipients = await getRecipients(recipientData);\n  if (recipients.length === 0) {\n    return { success: true, message: `No se encontraron destinatarios. No se enviaron correos.`, stats: { sentCount: 0, failedCount: 0, totalRecipients: 0, duration: 0 } };\n  }\n\n  const event = eventId ? events.find(e => e.id === eventId) : null;\n  const totalRecipients = recipients.length;\n  const graphClient = await getGraphClient();\n  let sentCount = 0;\n  let failedCount = 0;\n\n  const recipientBatches = [];\n  for (let i = 0; i < recipients.length; i += batchSize) {\n    recipientBatches.push(recipients.slice(i, i + batchSize));\n  }\n\n  for (const [index, batch] of recipientBatches.entries()) {\n    for (const contact of batch) {\n        try {\n            let finalHtmlBody = htmlBody;\n            if (contact.name) {\n              finalHtmlBody = finalHtmlBody.replace(/{{contact.name}}/g, contact.name);\n            }\n            if (event) {\n              finalHtmlBody = finalHtmlBody.replace(/{{event.date}}/g, event.date);\n            }\n            // Clean up any unreplaced placeholders\n            finalHtmlBody = finalHtmlBody.replace(/{{contact.name}}/g, '');\n            finalHtmlBody = finalHtmlBody.replace(/{{event.date}}/g, '');\n\n            const message = {\n                subject: subject,\n                body: { contentType: 'HTML', content: finalHtmlBody },\n                toRecipients: [{ emailAddress: { address: contact.email } }],\n                attachments: attachment ? [\n                  {\n                      '@odata.type': '#microsoft.graph.fileAttachment',\n                      name: attachment.filename,\n                      contentType: attachment.contentType,\n                      contentBytes: attachment.content,\n                  }\n                ] : undefined,\n            };\n            await graphClient.api(`/users/${GRAPH_USER_MAIL}/sendMail`).post({ message, saveToSentItems: 'true' });\n            sentCount++;\n        } catch (error) {\n            failedCount++;\n            const errorMessage = (error as any)?.body ? JSON.parse((error as any).body).error.message : (error as Error).message;\n            console.error(`Error al enviar correo a ${contact.email} usando Graph:`, errorMessage);\n        }\n        \n        if(emailDelay > 0) await delay(emailDelay);\n    }\n    \n    if (index < recipientBatches.length - 1) {\n      if(batchDelay > 0) await delay(batchDelay * 1000);\n    }\n  }\n  \n  const endTime = Date.now();\n  const duration = (endTime - startTime) / 1000;\n\n  let message = `Envío completado con Microsoft Graph. Enviados: ${sentCount}. Fallidos: ${failedCount}.`;\n  if (failedCount > 0) {\n    message += ' Revisa la consola del servidor para más detalles sobre los errores.';\n  }\n\n  return { success: true, message, stats: { sentCount, failedCount, totalRecipients, duration } };\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 646, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/app/actions/send-test-email-action.ts"],"sourcesContent":["'use server';\n\nimport 'isomorphic-fetch';\nimport { ClientSecretCredential } from '@azure/identity';\nimport { Client } from '@microsoft/microsoft-graph-client';\nimport { TokenCredentialAuthenticationProvider } from '@microsoft/microsoft-graph-client/authProviders/azureTokenCredentials';\nimport { format } from 'date-fns';\nimport { es } from 'date-fns/locale';\nimport { events } from '@/lib/data';\n\n/**\n * @fileoverview Acción de servidor para enviar un único correo de prueba.\n */\n\ninterface SendTestEmailPayload {\n  subject: string;\n  htmlBody: string;\n  recipientEmail: string;\n  attachment?: {\n    filename: string;\n    contentType: string;\n    content: string; // base64 content\n  };\n  eventId?: string;\n}\n\nasync function getGraphClient() {\n    const { GRAPH_CLIENT_ID, GRAPH_TENANT_ID, GRAPH_CLIENT_SECRET } = process.env;\n    if (!GRAPH_CLIENT_ID || !GRAPH_TENANT_ID || !GRAPH_CLIENT_SECRET) {\n        throw new Error('Faltan las variables de entorno de Microsoft Graph. Por favor, configúralas en Ajustes.');\n    }\n    const credential = new ClientSecretCredential(GRAPH_TENANT_ID, GRAPH_CLIENT_ID, GRAPH_CLIENT_SECRET);\n    const authProvider = new TokenCredentialAuthenticationProvider(credential, { scopes: ['https://graph.microsoft.com/.default'] });\n    return Client.initWithMiddleware({ authProvider });\n}\n\nexport async function sendTestEmailAction(payload: SendTestEmailPayload): Promise<{ success: boolean }> {\n  const { subject, htmlBody, recipientEmail, attachment, eventId } = payload;\n  \n  const { GRAPH_USER_MAIL } = process.env;\n  if (!GRAPH_USER_MAIL) {\n    throw new Error('Falta la variable de entorno GRAPH_USER_MAIL. Por favor, configúrala.');\n  }\n\n  const event = eventId ? events.find(e => e.id === eventId) : null;\n  \n  let finalHtmlBody = htmlBody;\n  // Replace placeholders with test data\n  finalHtmlBody = finalHtmlBody.replace(/{{contact.name}}/g, 'Usuario de Prueba');\n  if (event) {\n    finalHtmlBody = finalHtmlBody.replace(/{{event.date}}/g, event.date);\n  } else {\n    // If no event, use today's date for placeholder\n    finalHtmlBody = finalHtmlBody.replace(/{{event.date}}/g, format(new Date(), 'PPP', { locale: es }));\n  }\n  // Clean up any other unreplaced placeholders\n  finalHtmlBody = finalHtmlBody.replace(/{{contact.name}}/g, '');\n  finalHtmlBody = finalHtmlBody.replace(/{{event.date}}/g, '');\n\n\n  const message = {\n    subject: `[PRUEBA] ${subject}`,\n    body: { contentType: 'HTML', content: finalHtmlBody },\n    toRecipients: [{ emailAddress: { address: recipientEmail } }],\n    attachments: attachment ? [\n      {\n          '@odata.type': '#microsoft.graph.fileAttachment',\n          name: attachment.filename,\n          contentType: attachment.contentType,\n          contentBytes: attachment.content,\n      }\n    ] : undefined,\n  };\n\n  try {\n    const graphClient = await getGraphClient();\n    await graphClient.api(`/users/${GRAPH_USER_MAIL}/sendMail`).post({ message, saveToSentItems: 'true' });\n    return { success: true };\n  } catch (error) {\n    const errorMessage = (error as any)?.body ? JSON.parse((error as any).body).error.message : (error as Error).message;\n    console.error(`Error al enviar correo de prueba a ${recipientEmail} usando Graph:`, errorMessage);\n    throw new Error(`No se pudo enviar el correo de prueba: ${errorMessage}`);\n  }\n}\n"],"names":[],"mappings":";;;;;AAEA;AACA;AAAA;AACA;AAAA;AACA;AACA;AACA;AACA;;;;;;;;;;;AAkBA,eAAe;IACX,MAAM,EAAE,eAAe,EAAE,eAAe,EAAE,mBAAmB,EAAE,GAAG,QAAQ,GAAG;IAC7E,IAAI,CAAC,mBAAmB,CAAC,mBAAmB,CAAC,qBAAqB;QAC9D,MAAM,IAAI,MAAM;IACpB;IACA,MAAM,aAAa,IAAI,2LAAA,CAAA,yBAAsB,CAAC,iBAAiB,iBAAiB;IAChF,MAAM,eAAe,IAAI,8MAAA,CAAA,wCAAqC,CAAC,YAAY;QAAE,QAAQ;YAAC;SAAuC;IAAC;IAC9H,OAAO,yLAAA,CAAA,SAAM,CAAC,kBAAkB,CAAC;QAAE;IAAa;AACpD;AAEO,eAAe,oBAAoB,OAA6B;IACrE,MAAM,EAAE,OAAO,EAAE,QAAQ,EAAE,cAAc,EAAE,UAAU,EAAE,OAAO,EAAE,GAAG;IAEnE,MAAM,EAAE,eAAe,EAAE,GAAG,QAAQ,GAAG;IACvC,IAAI,CAAC,iBAAiB;QACpB,MAAM,IAAI,MAAM;IAClB;IAEA,MAAM,QAAQ,UAAU,kHAAA,CAAA,SAAM,CAAC,IAAI,CAAC,CAAA,IAAK,EAAE,EAAE,KAAK,WAAW;IAE7D,IAAI,gBAAgB;IACpB,sCAAsC;IACtC,gBAAgB,cAAc,OAAO,CAAC,qBAAqB;IAC3D,IAAI,OAAO;QACT,gBAAgB,cAAc,OAAO,CAAC,mBAAmB,MAAM,IAAI;IACrE,OAAO;QACL,gDAAgD;QAChD,gBAAgB,cAAc,OAAO,CAAC,mBAAmB,CAAA,GAAA,sJAAA,CAAA,SAAM,AAAD,EAAE,IAAI,QAAQ,OAAO;YAAE,QAAQ,4IAAA,CAAA,KAAE;QAAC;IAClG;IACA,6CAA6C;IAC7C,gBAAgB,cAAc,OAAO,CAAC,qBAAqB;IAC3D,gBAAgB,cAAc,OAAO,CAAC,mBAAmB;IAGzD,MAAM,UAAU;QACd,SAAS,CAAC,SAAS,EAAE,SAAS;QAC9B,MAAM;YAAE,aAAa;YAAQ,SAAS;QAAc;QACpD,cAAc;YAAC;gBAAE,cAAc;oBAAE,SAAS;gBAAe;YAAE;SAAE;QAC7D,aAAa,aAAa;YACxB;gBACI,eAAe;gBACf,MAAM,WAAW,QAAQ;gBACzB,aAAa,WAAW,WAAW;gBACnC,cAAc,WAAW,OAAO;YACpC;SACD,GAAG;IACN;IAEA,IAAI;QACF,MAAM,cAAc,MAAM;QAC1B,MAAM,YAAY,GAAG,CAAC,CAAC,OAAO,EAAE,gBAAgB,SAAS,CAAC,EAAE,IAAI,CAAC;YAAE;YAAS,iBAAiB;QAAO;QACpG,OAAO;YAAE,SAAS;QAAK;IACzB,EAAE,OAAO,OAAO;QACd,MAAM,eAAe,AAAC,OAAe,OAAO,KAAK,KAAK,CAAC,AAAC,MAAc,IAAI,EAAE,KAAK,CAAC,OAAO,GAAG,AAAC,MAAgB,OAAO;QACpH,QAAQ,KAAK,CAAC,CAAC,mCAAmC,EAAE,eAAe,cAAc,CAAC,EAAE;QACpF,MAAM,IAAI,MAAM,CAAC,uCAAuC,EAAE,cAAc;IAC1E;AACF;;;IA/CsB;;AAAA,+OAAA","debugId":null}},
    {"offset": {"line": 754, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/.next-internal/server/app/%28main%29/send/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {sendCampaign as '401372f659c5451f99035a7f116333db4ac66a7ce4'} from 'ACTIONS_MODULE0'\nexport {sendTestEmailAction as '406b923f738831070980d62a75596a77849741996f'} from 'ACTIONS_MODULE1'\n"],"names":[],"mappings":";AAAA;AACA","debugId":null}},
    {"offset": {"line": 818, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/app/%28main%29/send/page.tsx/proxy.mjs"],"sourcesContent":["import { registerClientReference } from \"react-server-dom-turbopack/server.edge\";\nexport default registerClientReference(\n    function() { throw new Error(\"Attempted to call the default export of [project]/src/app/(main)/send/page.tsx <module evaluation> from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/src/app/(main)/send/page.tsx <module evaluation>\",\n    \"default\",\n);\n"],"names":[],"mappings":";;;AAAA;;uCACe,CAAA,GAAA,qPAAA,CAAA,0BAAuB,AAAD,EACjC;IAAa,MAAM,IAAI,MAAM;AAAgS,GAC7T,8DACA","debugId":null}},
    {"offset": {"line": 832, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/app/%28main%29/send/page.tsx/proxy.mjs"],"sourcesContent":["import { registerClientReference } from \"react-server-dom-turbopack/server.edge\";\nexport default registerClientReference(\n    function() { throw new Error(\"Attempted to call the default export of [project]/src/app/(main)/send/page.tsx from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/src/app/(main)/send/page.tsx\",\n    \"default\",\n);\n"],"names":[],"mappings":";;;AAAA;;uCACe,CAAA,GAAA,qPAAA,CAAA,0BAAuB,AAAD,EACjC;IAAa,MAAM,IAAI,MAAM;AAA4Q,GACzS,0CACA","debugId":null}},
    {"offset": {"line": 846, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}}]
}